<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>GoldenMoon-DE</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Ensuring the body handles the background correctly */
        body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            background-color: black;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            transition: background-image 0.5s ease-in-out; /* Smooth fade when changing */
        }
    </style>
</head>
<body>

<div id="desktop"></div>

<div id="taskbar-top">
    <div id="top-text">GoldenMoon-DE</div>
    <div id="clock"></div>
</div>

<div id="taskbar-bottom">
    <div class="taskbar-left">
        <div id="start-menu" class="hidden">
            <div class="start-menu-content">
                <div class="spacer"></div>
            </div>
            <div class="start-menu-footer">
                <div class="power-buttons">
                    <button onclick="sendToPython({action: 'open_bg_picker'})" title="Set Background">üñºÔ∏è</button>
                    <button onclick="sendToPython({action: 'power_command', command: 'sleep'})" title="Sleep">·∂ªùóì</button>
                    <button onclick="sendToPython({action: 'power_command', command: 'restart'})" title="Restart">‚Ü∫</button>
                    <button onclick="sendToPython({action: 'power_command', command: 'shutdown'})" title="Shutdown" class="shutdown-btn">‚èª</button>
                </div>
            </div>
        </div>
        <div class="start-btn" onclick="toggleStartMenu()">‚äû</div>
    </div>

    <div class="taskbar-center" id="dock-container">
        </div>

    <div class="taskbar-right"></div>
</div>

<script>
/* --- UI UTILITIES --- */

function updateClock() {
    const now = new Date();
    document.getElementById("clock").innerText =
        now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
}
setInterval(updateClock, 1000);
updateClock();

function toggleStartMenu() {
    document.getElementById('start-menu').classList.toggle('hidden');
}

document.getElementById('desktop').addEventListener('click', () => {
    document.getElementById('start-menu').classList.add('hidden');
});

document.getElementById('start-menu').addEventListener('click', (e) => e.stopPropagation());

/* --- BACKGROUND MANAGEMENT --- */

const DEFAULT_BG = "wallpaper.png";

function applyBackground(path) {
    // If path is null, empty, or undefined, use wallpaper.png
    const finalPath = (path && path.trim() !== "") ? path : DEFAULT_BG;
    console.log("Setting background to:", finalPath);
    document.body.style.backgroundImage = `url('${finalPath}')`;
}

// Called by Python to send the saved string from config.json
function receiveSavedBackground(savedPath) {
    applyBackground(savedPath);
}

/* --- COMMUNICATION BRIDGE --- */

let currentApps = [];

function sendToPython(data) {
    if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.bridge) {
        window.webkit.messageHandlers.bridge.postMessage(JSON.stringify(data));
    }
}

function receiveDockData(apps) {
    currentApps = apps;
    const container = document.getElementById("dock-container");
    container.innerHTML = "";
    apps.forEach(app => {
        const appEl = document.createElement("div");
        appEl.className = "app";
        appEl.id = `dock-${app.id}`;
        appEl.innerHTML = `<img src="${app.icon_path}" style="width:28px; height:28px;">`;
        appEl.onclick = () => {
            const action = appEl.classList.contains("running") ? "focus_app" : "launch_app";
            sendToPython({ action: action, command: app.exec });
        };
        container.appendChild(appEl);
    });
}

function updateRunningIndicators(runningList) {
    currentApps.forEach(app => {
        const el = document.getElementById(`dock-${app.id}`);
        if (!el) return;
        const isRunning = runningList.some(name => app.exec.toLowerCase().includes(name));
        el.classList.toggle("running", isRunning);
    });
}

/* --- INITIALIZATION --- */

window.onload = () => {
    // 1. Set immediate default background
    applyBackground(DEFAULT_BG);
    
    // 2. Fetch system data from Python
    sendToPython({ action: "get_dock_apps" });
    sendToPython({ action: "get_power_icons" });
    sendToPython({ action: "get_saved_background" });
};

// Protection against dragging/selection on taskbars
[document.getElementById('taskbar-top'), document.getElementById('taskbar-bottom')].forEach(bar => {
    bar.addEventListener('mousedown', e => e.preventDefault());
    bar.addEventListener('selectstart', e => e.preventDefault());
});
</script>

</body>
</html>