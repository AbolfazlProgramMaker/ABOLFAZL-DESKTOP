<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>GoldenMoon-DE</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<div id="desktop"></div>

<!-- TOP TASKBAR -->
<div id="taskbar-top">
    <div id="top-text">GoldenMoon-DE</div>
    <div id="clock"></div>
</div>

<!-- BOTTOM TASKBAR -->
<div id="taskbar-bottom">
    <div class="taskbar-left">
        <!-- startmenu -->
        <div id="start-menu" class="hidden">
    <div class="start-menu-content">
        <div class="spacer"></div>
    </div>
    <div class="start-menu-footer">
        <div class="power-buttons">
            <button onclick="sendToPython({action: 'power_command', command: 'sleep'})" title="Sleep">á¶»ğ—“</button>
            <button onclick="sendToPython({action: 'power_command', command: 'restart'})" title="Restart">â†º</button>
            <button onclick="sendToPython({action: 'power_command', command: 'shutdown'})" title="Shutdown" class="shutdown-btn">â»</button>
        </div>
    </div>
</div>

<div class="start-btn" onclick="toggleStartMenu()">âŠ</div>
    </div>

    <div class="taskbar-center">
        <div class="app active">ğŸŒ</div>
        <div class="app">ğŸ“</div>
        <div class="app">âš™ï¸</div>
        <div class="app">ğŸ–¥ï¸</div>
    </div>

    <div class="taskbar-right"></div>
</div>

<script>
// CLOCK FOR TOP TASKBAR (with seconds)
function updateClock() {
    const now = new Date();
    document.getElementById("clock").innerText =
        now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
}
setInterval(updateClock, 1000);
updateClock();

// ANTI-COPY PROTECTION
const allTaskbars = [document.getElementById('taskbar-top'), document.getElementById('taskbar-bottom')];

allTaskbars.forEach(taskbar => {
    const items = taskbar.querySelectorAll('*');
    items.forEach(el => {
        el.addEventListener('mousedown', e => e.preventDefault());
        el.addEventListener('selectstart', e => e.preventDefault());
        el.addEventListener('dragstart', e => e.preventDefault());
        el.style.cursor = 'default';
    });
    taskbar.addEventListener('mousedown', e => e.preventDefault());
    taskbar.addEventListener('selectstart', e => e.preventDefault());
    taskbar.style.cursor = 'default';
});
// --- Communication Bridge ---

let currentApps = [];

function sendToPython(data) {
    window.webkit.messageHandlers.bridge.postMessage(JSON.stringify(data));
}

function receiveDockData(apps) {
    currentApps = apps;
    const container = document.querySelector(".taskbar-center");
    container.innerHTML = "";

    apps.forEach(app => {
        const appEl = document.createElement("div");
        appEl.className = "app";
        appEl.id = `dock-${app.id}`;
        appEl.innerHTML = `<img src="${app.icon_path}" style="width:28px; height:28px;">`;
        
        appEl.onclick = () => {
            if (appEl.classList.contains("running")) {
                sendToPython({ action: "focus_app", command: app.exec });
            } else {
                sendToPython({ action: "launch_app", command: app.exec });
            }
        };
        container.appendChild(appEl);
    });
}

function updateRunningIndicators(runningList) {
    currentApps.forEach(app => {
        const el = document.getElementById(`dock-${app.id}`);
        if (!el) return;
        // Simple match: if the exec name is in the window class list
        const isRunning = runningList.some(name => app.exec.toLowerCase().includes(name));
        el.classList.toggle("running", isRunning);
    });
}

function onLaunchResult(success, error) {
    if (!success) alert("Failed: " + error);
}
function toggleStartMenu() {
    const menu = document.getElementById('start-menu');
    menu.classList.toggle('hidden');
}

// Close start menu if clicking on the desktop (outside the menu)
document.getElementById('desktop').addEventListener('click', () => {
    document.getElementById('start-menu').classList.add('hidden');
});

// Prevent clicking inside the menu from closing it
document.getElementById('start-menu').addEventListener('click', (e) => {
    e.stopPropagation();
});
// Function to receive and set the icons
function receivePowerIcons(icons) {
    document.getElementById('btn-sleep').innerHTML = `<img src="${icons.sleep}" style="width:20px; height:20px;">`;
    document.getElementById('btn-restart').innerHTML = `<img src="${icons.restart}" style="width:20px; height:20px;">`;
    document.getElementById('btn-shutdown').innerHTML = `<img src="${icons.shutdown}" style="width:20px; height:20px;">`;
}

// Update your window.onload to request both dock apps AND power icons
window.onload = () => {
    sendToPython({ action: "get_dock_apps" });
    sendToPython({ action: "get_power_icons" });
};
// Initial Request
window.onload = () => sendToPython({ action: "get_dock_apps" });
</script>

</body>
</html>
